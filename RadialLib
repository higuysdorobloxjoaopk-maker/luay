local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local RadialLib = {}
RadialLib.__index = RadialLib

function RadialLib.new(titleText)
    local self = setmetatable({}, RadialLib)
    
    -- Container Principal (Protegido contra reset de spawn)
    self.Gui = Instance.new("ScreenGui")
    self.Gui.Name = "DeltaRadial_Lib"
    self.Gui.Parent = CoreGui
    self.Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- Botão de Toggle (Canto Superior)
    self.MainToggle = Instance.new("TextButton")
    self.MainToggle.Name = "ControlBtn"
    self.MainToggle.Parent = self.Gui
    self.MainToggle.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    self.MainToggle.BorderSizePixel = 0
    self.MainToggle.Position = UDim2.new(0, 10, 0, 10)
    self.MainToggle.Size = UDim2.new(0, 45, 0, 45)
    self.MainToggle.Text = "R"
    self.MainToggle.TextColor3 = Color3.new(1, 1, 1)
    self.MainToggle.Font = Enum.Font.GothamBold
    self.MainToggle.TextSize = 20
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = self.MainToggle

    -- Frame da Roda (Onde tudo acontece)
    self.WheelFrame = Instance.new("Frame")
    self.WheelFrame.Name = "Wheel"
    self.WheelFrame.Parent = self.Gui
    self.WheelFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    self.WheelFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    self.WheelFrame.BackgroundTransparency = 1
    self.WheelFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    self.WheelFrame.Size = UDim2.new(0, 0, 0, 0) -- Começa invisível
    self.WheelFrame.Visible = false

    -- Centro da Roda
    self.Center = Instance.new("Frame")
    self.Center.Name = "Center"
    self.Center.Parent = self.WheelFrame
    self.Center.AnchorPoint = Vector2.new(0.5, 0.5)
    self.Center.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    self.Center.Position = UDim2.new(0.5, 0, 0.5, 0)
    self.Center.Size = UDim2.new(0, 140, 0, 140)
    self.Center.ZIndex = 10

    local centerCorner = Instance.new("UICorner")
    centerCorner.CornerRadius = UDim.new(1, 0)
    centerCorner.Parent = self.Center

    self.Title = Instance.new("TextLabel")
    self.Title.Parent = self.Center
    self.Title.Size = UDim2.new(1, -20, 1, -20)
    self.Title.Position = UDim2.new(0.5, 0, 0.5, 0)
    self.Title.AnchorPoint = Vector2.new(0.5, 0.5)
    self.Title.BackgroundTransparency = 1
    self.Title.Text = titleText or "Selecione um emote"
    self.Title.TextColor3 = Color3.new(1, 1, 1)
    self.Title.Font = Enum.Font.GothamMedium
    self.Title.TextSize = 18
    self.Title.TextWrapped = true
    self.Title.ZIndex = 11

    -- Variáveis de Estado
    self.Items = {}
    self.CurrentPage = 1
    self.IsOpen = false
    self.IsSpinning = false

    -- Evento de Abrir/Fechar
    self.MainToggle.MouseButton1Click:Connect(function()
        self:ToggleVisibility()
    end)

    return self
end

function RadialLib:ToggleVisibility()
    self.IsOpen = not self.IsOpen
    if self.IsOpen then
        self.WheelFrame.Visible = true
        TweenService:Create(self.WheelFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back), {Size = UDim2.new(0, 420, 0, 420)}):Play()
    else
        local t = TweenService:Create(self.WheelFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {Size = UDim2.new(0, 0, 0, 0)})
        t:Play()
        t.Completed:Wait()
        if not self.IsOpen then self.WheelFrame.Visible = false end
    end
end

function RadialLib:AddButton(name, icon, isToggle, callback)
    table.insert(self.Items, {
        Name = name,
        Icon = icon or "",
        IsToggle = isToggle or false,
        Callback = callback,
        State = false
    })
    self:Refresh()
end

function RadialLib:Refresh()
    -- Limpa botões antigos (exceto o centro)
    for _, v in pairs(self.WheelFrame:GetChildren()) do
        if v.Name == "ItemBtn" or v.Name == "NavBtn" then v:Destroy() end
    end

    local start = (self.CurrentPage - 1) * 8 + 1
    local totalItems = #self.Items
    
    -- Criar Setas se necessário
    if totalItems > 8 then
        self:CreateNavButton("Next", 1)
        self:CreateNavButton("Back", -1)
    end

    -- Renderizar até 8 itens
    for i = 0, 7 do
        local item = self.Items[start + i]
        if not item then break end

        local angle = (i * 45) - 90
        local rad = math.rad(angle)
        
        local btn = Instance.new("ImageButton")
        btn.Name = "ItemBtn"
        btn.Parent = self.WheelFrame
        btn.Size = UDim2.new(0, 75, 0, 75)
        btn.AnchorPoint = Vector2.new(0.5, 0.5)
        btn.Position = UDim2.new(0.5 + math.cos(rad) * 0.38, 0, 0.5 + math.sin(rad) * 0.38, 0)
        btn.BackgroundColor3 = item.State and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(45, 45, 45)
        btn.BackgroundTransparency = 0.2
        btn.Image = item.Icon
        
        local c = Instance.new("UICorner")
        c.CornerRadius = UDim.new(1, 0)
        c.Parent = btn

        local label = Instance.new("TextLabel")
        label.Parent = btn
        label.Size = UDim2.new(1, 0, 0, 20)
        label.Position = UDim2.new(0.5, 0, 1, 5)
        label.AnchorPoint = Vector2.new(0.5, 0)
        label.BackgroundTransparency = 1
        label.Text = item.Name
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.Gotham
        label.TextSize = 12

        btn.MouseButton1Click:Connect(function()
            if item.IsToggle then
                item.State = not item.State
                btn.BackgroundColor3 = item.State and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(45, 45, 45)
            end
            item.Callback(item.State)
        end)
    end
end

function RadialLib:CreateNavButton(dir, val)
    local btn = Instance.new("TextButton")
    btn.Name = "NavBtn"
    btn.Parent = self.WheelFrame
    btn.Size = UDim2.new(0, 40, 0, 40)
    btn.AnchorPoint = Vector2.new(0.5, 0.5)
    btn.Text = (dir == "Next") and ">" or "<"
    btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    btn.TextColor3 = Color3.new(1, 1, 1)
    
    -- Posicionamento das setas (Canto inferior)
    if dir == "Next" then
        btn.Position = UDim2.new(0.9, 0, 0.9, 0)
    else
        btn.Position = UDim2.new(0.1, 0, 0.9, 0)
    end

    Instance.new("UICorner", btn).CornerRadius = UDim.new(1, 0)

    btn.MouseButton1Click:Connect(function()
        if self.IsSpinning then return end
        self.IsSpinning = true
        
        -- Animação de Giro
        local targetRotation = (val == 1) and 360 or -360
        local spin = TweenService:Create(self.WheelFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.InOut), {Rotation = targetRotation})
        
        spin:Play()
        spin.Completed:Connect(function()
            self.WheelFrame.Rotation = 0
            self.CurrentPage = self.CurrentPage + val
            if self.CurrentPage < 1 then self.CurrentPage = 1 end
            self:Refresh()
            self.IsSpinning = false
        end)
    end)
end

return RadialLib
