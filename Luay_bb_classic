local luayV2 = {}

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

local plr = players.LocalPlayer
local mouse = plr:GetMouse()

-- Mapa de Ícones Padrão
local ICON_MAP = {
    ["house"] = "rbxassetid://7072706663",
    ["settings"] = "rbxassetid://7072721682",
    ["combat"] = "rbxassetid://7072882435",
    ["folder"] = "rbxassetid://7072706503"
}

function luayV2:Window(config)
    local Window = {
        MainColor = config.Color or Color3.fromRGB(0, 170, 255),
        Title = config.Name or "LUAY V2",
        Running = true
    }

    local ScreenGui = Instance.new("ScreenGui", CoreGui)
    ScreenGui.Name = "luay_" .. HttpService:GenerateGUID(false)

    -- Frame Principal (QUADRADO)
    local Main = Instance.new("Frame", ScreenGui)
    Main.Size = UDim2.new(0, 320, 0, 380)
    Main.Position = UDim2.new(0.5, -160, 0.5, -190)
    Main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Main.BorderSizePixel = 0
    Main.ClipsDescendants = true

    -- Barra Lateral de Destaque (Esquerda)
    local LeftAccent = Instance.new("Frame", Main)
    LeftAccent.Size = UDim2.new(0, 3, 1, 0)
    LeftAccent.BackgroundColor3 = Window.MainColor
    LeftAccent.BorderSizePixel = 0
    LeftAccent.ZIndex = 10

    -- Barra Superior (QUADRADA)
    local TopBar = Instance.new("Frame", Main)
    TopBar.Size = UDim2.new(1, 0, 0, 35)
    TopBar.BackgroundColor3 = Color3.fromRGB(22, 22, 22)
    TopBar.BorderSizePixel = 0

    local Title = Instance.new("TextLabel", TopBar)
    Title.Text = Window.Title:upper()
    Title.Size = UDim2.new(1, -100, 1, 0)
    Title.Position = UDim2.new(0, 15, 0, 0)
    Title.TextColor3 = Color3.new(1, 1, 1)
    Title.Font = "Code"; Title.TextSize = 14; Title.TextXAlignment = "Left"; Title.BackgroundTransparency = 1

    -- Botões de Controle
    local CloseBtn = Instance.new("TextButton", TopBar)
    CloseBtn.Size = UDim2.new(0, 35, 0, 35); CloseBtn.Position = UDim2.new(1, -35, 0, 0)
    CloseBtn.Text = "×"; CloseBtn.TextColor3 = Color3.fromRGB(255, 80, 80); CloseBtn.Font = "GothamBold"; CloseBtn.TextSize = 20; CloseBtn.BackgroundTransparency = 1

    local MiniBtn = Instance.new("TextButton", TopBar)
    MiniBtn.Size = UDim2.new(0, 35, 0, 35); MiniBtn.Position = UDim2.new(1, -70, 0, 0)
    MiniBtn.Text = "—"; MiniBtn.TextColor3 = Color3.new(1, 1, 1); MiniBtn.Font = "GothamBold"; MiniBtn.TextSize = 16; MiniBtn.BackgroundTransparency = 1

    -- ANIMAÇÃO DE FECHAR (X)
    CloseBtn.MouseButton1Click:Connect(function()
        Window.Running = false -- Para as funções
        -- 1. Minimiza vertical
        local t1 = TweenService:Create(Main, TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {Size = UDim2.new(0, 320, 0, 35)})
        t1:Play()
        t1.Completed:Wait()
        -- 2. Minimiza pro lado (encolhe largura)
        local t2 = TweenService:Create(Main, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {Size = UDim2.new(0, 0, 0, 35), Position = Main.Position + UDim2.new(0, 160, 0, 0)})
        t2:Play()
        t2.Completed:Wait()
        ScreenGui:Destroy()
    end)

    -- Minimizar Simples
    local minimized = false
    MiniBtn.MouseButton1Click:Connect(function()
        minimized = not minimized
        TweenService:Create(Main, TweenInfo.new(0.4), {Size = minimized and UDim2.new(0, 320, 0, 35) or UDim2.new(0, 320, 0, 380)}):Play()
    end)

    -- Função para mudar cor dinamicamente
    function Window:SetTheme(newColor)
        Window.MainColor = newColor
        LeftAccent.BackgroundColor3 = newColor
    end

    -- Draggable
    local dragging, dragInput, dragStart, startPos
    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true; dragStart = input.Position; startPos = Main.Position end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)

    -- Sidebar e Container
    local Sidebar = Instance.new("ScrollingFrame", Main)
    Sidebar.Size = UDim2.new(0, 45, 1, -45); Sidebar.Position = UDim2.new(0, 5, 0, 40)
    Sidebar.BackgroundTransparency = 1; Sidebar.ScrollBarThickness = 0
    Instance.new("UIListLayout", Sidebar).Padding = UDim.new(0, 5)

    local Container = Instance.new("Frame", Main)
    Container.Size = UDim2.new(1, -60, 1, -45); Container.Position = UDim2.new(0, 55, 0, 40)
    Container.BackgroundTransparency = 1

    function Window:Area(name, icon)
        local AreaFrame = Instance.new("ScrollingFrame", Container)
        AreaFrame.Size = UDim2.new(1, 0, 1, 0); AreaFrame.BackgroundTransparency = 1; AreaFrame.Visible = false; AreaFrame.ScrollBarThickness = 2
        Instance.new("UIListLayout", AreaFrame).Padding = UDim.new(0, 5)

        local TabBtn = Instance.new("ImageButton", Sidebar)
        TabBtn.Size = UDim2.new(0, 32, 0, 32); TabBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        TabBtn.Image = ICON_MAP[icon] or icon; TabBtn.BorderSizePixel = 0
        TabBtn.ImageColor3 = Color3.fromRGB(150, 150, 150)

        TabBtn.MouseButton1Click:Connect(function()
            for _, v in pairs(Container:GetChildren()) do if v:IsA("ScrollingFrame") then v.Visible = false end end
            for _, v in pairs(Sidebar:GetChildren()) do if v:IsA("ImageButton") then v.ImageColor3 = Color3.fromRGB(150, 150, 150) end end
            AreaFrame.Visible = true
            TabBtn.ImageColor3 = Window.MainColor
        end)

        if not Window.CurrentTab then Window.CurrentTab = AreaFrame; AreaFrame.Visible = true; TabBtn.ImageColor3 = Window.MainColor end

        local Elements = {}
        function Elements:Toggle(text, callback)
            local state = false
            local tBtn = Instance.new("TextButton", AreaFrame)
            tBtn.Size = UDim2.new(0.95, 0, 0, 30); tBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
            tBtn.Text = "  " .. text; tBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
            tBtn.Font = "Code"; tBtn.TextSize = 12; tBtn.TextXAlignment = "Left"; tBtn.BorderSizePixel = 0
            
            tBtn.MouseButton1Click:Connect(function()
                if not Window.Running then return end
                state = not state
                tBtn.TextColor3 = state and Window.MainColor or Color3.fromRGB(200, 200, 200)
                callback(state)
            end)
        end
        return Elements
    end
    return Window
end

return luayV2
